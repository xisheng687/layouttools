# 微信公众号排版工具 (format-wechat.js)

## 简介

这是一个将 Markdown 文件转换为微信公众号友好的 HTML 格式的命令行工具。设计风格参考小马宋文章排版，特点是简洁、易读、专业。

## 使用方法

```bash
node format-wechat.js <输入文件.md> [选项]
```

### 选项

| 选项 | 说明 |
|------|------|
| `--preview` | 生成完整 HTML 预览文件（可在浏览器打开，包含字数统计和复制按钮） |
| `--html` | 仅输出 HTML 格式 |
| `--md` | 仅输出格式化的 MD 文件 |
| （无选项） | 同时输出 HTML 和 MD 两种格式 |

### 示例

```bash
# 基本用法：同时生成 HTML 和格式化的 MD
node format-wechat.js article.md

# 生成可预览的 HTML（带字数统计和复制按钮）
node format-wechat.js article.md --preview

# 仅生成 HTML
node format-wechat.js article.md --html
```

### 输出文件

- `<文件名>_wechat.html` - 转换后的 HTML 文件
- `<文件名>_formatted.md` - 格式化后的 Markdown 文件

---

## 功能详解：输入到输出的转换

### 一、样式配置

工具使用以下默认样式（可在代码中修改 `CONFIG` 对象调整）：

| 配置项 | 值 | 说明 |
|--------|----|----|
| `headingColor` | `#1d4ed8` | 标题颜色（深蓝色） |
| `boldColor` | `#60a5fa` | 加粗文字颜色（浅蓝色） |
| `textColor` | `#333333` | 正文颜色（深灰色） |
| `fontSize` | `16px` | 正文字号 |
| `lineHeight` | `1.8` | 行高 |
| `paragraphMargin` | `1.5em` | 段落间距 |
| `h1Size` | `24px` | 一级标题字号 |
| `h2Size` | `20px` | 二级标题字号 |
| `h3Size` | `18px` | 三级标题字号 |

---

### 二、Markdown 转换规则

#### 1. 标题处理

| 输入 | 输出 |
|------|------|
| `# 标题` | `<h1>` 深蓝色、24px、加粗 |
| `## 标题` | `<h2>` 深蓝色、20px、加粗 |
| `### 标题` | `<h3>` 深蓝色、18px、加粗 |

标题前后会自动添加额外空行，确保视觉分隔清晰。

#### 2. 文本格式化

| Markdown 语法 | 转换结果 | 说明 |
|---------------|----------|------|
| `**加粗文字**` | `<strong>` 浅蓝色加粗 | 使用 `#60a5fa` 颜色 |
| `__加粗文字__` | `<strong>` 浅蓝色加粗 | 同上 |
| `*斜体文字*` | `<em>` 斜体 | 不改变颜色 |
| `_斜体文字_` | `<em>` 斜体 | 同上 |
| `***加粗斜体***` | `<strong><em>` | 浅蓝色加粗+斜体 |
| `___加粗斜体___` | `<strong><em>` | 同上 |

#### 3. 列表处理（重要特性）

为适配微信公众号排版习惯，**列表标记会被移除**，转为普通段落：

| 输入 | 输出 |
|------|------|
| `- 列表项` | 转为普通段落 `<p>`，无圆点 |
| `* 列表项` | 转为普通段落 `<p>`，无圆点 |
| `+ 列表项` | 转为普通段落 `<p>`，无圆点 |
| `1. 有序列表` | 转为普通段落 `<p>`，无数字 |

#### 4. 链接处理

| 输入 | 输出 |
|------|------|
| `[文字](链接)` | `<a>` 蓝色链接（`#3b82f6`），无下划线 |

#### 5. 图片处理

| 输入 | 输出 |
|------|------|
| `![描述](图片链接)` | **移除**（微信不支持直接嵌入外部图片） |

#### 6. 引用块

| 输入 | 输出 |
|------|------|
| `> 引用文字` | `<blockquote>` 左侧蓝色边框、斜体、灰色文字 |

#### 7. 代码处理

| 输入 | 输出 |
|------|------|
| `` `行内代码` `` | 灰色背景、等宽字体 |
| ` ```代码块``` ` | 灰色背景、等宽字体、圆角边框 |

#### 8. 分割线

| 输入 | 输出 |
|------|------|
| `---` / `***` / `___` | `<hr>` 浅灰色细线 |

---

### 三、特殊字符处理

工具会自动进行以下字符替换和清理：

| 原字符 | 替换为 | 说明 |
|--------|--------|------|
| `「` | `"` | 中文角括号转双引号（左） |
| `」` | `"` | 中文角括号转双引号（右） |
| `*` | （移除） | 移除残留的星号 |

---

### 四、预览模式功能（--preview）

使用 `--preview` 选项生成的 HTML 文件包含以下增强功能：

#### 1. 字数统计

显示在页面顶部蓝色条中：
- **字数**：中文字符数 + 英文单词数
- **字符**：总字符数
- **不含空格**：去除空格后的字符数

#### 2. 复制按钮

提供三个复制按钮：
| 按钮 | 颜色 | 功能 |
|------|------|------|
| 复制全文 | 绿色 | 复制标题+正文 |
| 复制标题 | 蓝色 | 仅复制标题 |
| 复制正文 | 蓝色 | 仅复制正文内容 |

复制后按钮会短暂变为"已复制!"提示。

---

### 五、Markdown 格式化输出（_formatted.md）

同时生成的 `_formatted.md` 文件会进行以下优化：

1. **统一换行符** - 将 `\r\n` 转为 `\n`
2. **标题间距** - 确保标题前后有空行
3. **段落间距** - 合并多余空行，保持一致的段落间距
4. **文件结尾** - 确保文件以换行符结尾

---

## 技术细节

### 处理顺序

工具按以下顺序处理 Markdown，确保正确转换：

1. 保护代码块（避免被后续正则匹配）
2. 保护行内代码
3. 移除图片语法
4. 处理标题（h1-h3）
5. 处理 `***text***` 加粗斜体组合
6. 处理 `**text**` 加粗
7. 处理 `*text*` 斜体
8. 处理链接
9. 处理无序列表
10. 处理有序列表
11. 处理引用块
12. 处理分割线
13. 恢复代码块
14. 恢复行内代码
15. 包装段落
16. 替换中文角括号
17. 移除残留星号
18. 添加标题额外空行

### 已修复的问题

- **列表星号误识别**：`* 列表项` 中的 `*` 不会被误识别为斜体标记
- **嵌套格式**：`***text***` 正确生成 `<strong><em>text</em></strong>`
- **代码块占位符**：使用特殊字符避免被其他正则匹配
- **跨行匹配**：斜体正则不会跨行匹配

---

## 适用场景

- 微信公众号文章排版
- 需要内联样式的 HTML 邮件
- 不支持 CSS 类名的富文本编辑器

## 文件结构

```
Layout tools/
├── format-wechat.js          # 主程序
├── README-format-wechat.md   # 本文档
├── test_article_*.md         # 测试文章
└── *_wechat.html            # 生成的 HTML 文件
```
